# ============================================================================
# Track Record Enclave - Dev Docker Image (No SEV-SNP, No Rust build)
# ============================================================================

FROM node:20-alpine AS builder

RUN apk add --no-cache python3 make g++ openssl

WORKDIR /app

COPY package*.json ./
COPY tsconfig.json ./

RUN npm ci && npm cache clean --force

COPY src ./src
COPY prisma ./prisma

RUN npx prisma generate
RUN npm run build

# ============================================================================
# Runtime Stage
# ============================================================================
FROM node:20-alpine

RUN apk add --no-cache openssl ca-certificates tini curl

RUN addgroup -g 1001 enclave && \
    adduser -D -u 1001 -G enclave enclave

WORKDIR /app

COPY --chown=enclave:enclave package*.json ./
RUN npm ci --omit=dev && npm cache clean --force

COPY --from=builder --chown=enclave:enclave /app/dist ./dist
COPY --chown=enclave:enclave src/proto ./dist/proto

COPY --from=builder --chown=enclave:enclave /app/prisma ./prisma
COPY --from=builder --chown=enclave:enclave /app/node_modules/.prisma ./node_modules/.prisma
COPY --from=builder --chown=enclave:enclave /app/node_modules/@prisma ./node_modules/@prisma

# Generate self-signed TLS certificates for dev (gRPC requires them, no fallback)
RUN mkdir -p /etc/enclave /app/certs && \
    openssl req -x509 -newkey ec -pkeyopt ec_paramgen_curve:prime256v1 \
      -keyout /etc/enclave/server.key -out /etc/enclave/server.crt \
      -days 365 -nodes -subj "/CN=enclave-dev/O=TrackRecord/C=FR" && \
    cp /etc/enclave/server.crt /etc/enclave/ca.crt && \
    cp /etc/enclave/server.crt /app/certs/cert.pem && \
    cp /etc/enclave/server.key /app/certs/key.pem && \
    chown -R enclave:enclave /etc/enclave /app/certs && \
    chmod 600 /etc/enclave/server.key /app/certs/key.pem

ENV NODE_ENV=development
ENV ENCLAVE_PORT=50051
ENV REST_PORT=3050
ENV SKIP_ATTESTATION=true
ENV GRPC_INSECURE=true

HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD curl -fk https://localhost:3050/health || exit 1

EXPOSE 50051 3050

USER enclave

ENTRYPOINT ["/sbin/tini", "--"]
CMD ["node", "dist/index.js"]
